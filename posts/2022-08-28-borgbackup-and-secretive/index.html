






<!doctype html>
<html
  lang="en-us"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="light"
  data-auto-appearance="true"
><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#FFFFFF" />
  
  <title>Securing Offsite Borg Backups with Secretive and BorgBase &middot; Eric&#39;s Web.site</title>
    <meta name="title" content="Securing Offsite Borg Backups with Secretive and BorgBase &middot; Eric&#39;s Web.site" />
  
  
  
  
  
  <script
    type="text/javascript"
    src="/js/appearance.min.8a082f81b27f3cb2ee528df0b0bdc39787034cf2cc34d4669fbc9977c929023c.js"
    integrity="sha256-iggvgbJ/PLLuUo3wsL3Dl4cDTPLMNNRmn7yZd8kpAjw="
  ></script>
  
  
  
  
  
  
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.b0785c8131a75f72b211435af86269eb2d4b81dda03a8f2cf5ccb1c967747167.css"
    integrity="sha256-sHhcgTGnX3KyEUNa&#43;GJp6y1Lgd2gOo8s9cyxyWd0cWc="
  />
  
  
  
  
  
  
  
  <meta
    name="description"
    content="
      
        Borg #I am a big fan of Borg Backup for my backup needs. It&rsquo;s proven fast,
secure, efficient, and reliable in the years that I&rsquo;ve been using it. It&rsquo;s also free and
open-source, which is always a comfort.
I&rsquo;ve started using BorgBase for offsite backups. I generally
consider these backups to be my personal &ldquo;disaster recovery&rdquo; backups. This means, if my house
burns down, or someone manages to ransomware all of my data, I can still get back what I need.
      
    "
  />
  
  
  
  <link rel="canonical" href="https://ericsweb.site/posts/2022-08-28-borgbackup-and-secretive/" />
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="https://ericsweb.site/posts/2022-08-28-borgbackup-and-secretive/">
  <meta property="og:site_name" content="Eric&#39;s Web.site">
  <meta property="og:title" content="Securing Offsite Borg Backups with Secretive and BorgBase">
  <meta property="og:description" content="Borg #I am a big fan of Borg Backup for my backup needs. It’s proven fast, secure, efficient, and reliable in the years that I’ve been using it. It’s also free and open-source, which is always a comfort.
I’ve started using BorgBase for offsite backups. I generally consider these backups to be my personal “disaster recovery” backups. This means, if my house burns down, or someone manages to ransomware all of my data, I can still get back what I need.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-08-28T21:00:00-05:00">
    <meta property="article:modified_time" content="2022-08-28T21:00:00-05:00">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Securing Offsite Borg Backups with Secretive and BorgBase">
  <meta name="twitter:description" content="Borg #I am a big fan of Borg Backup for my backup needs. It’s proven fast, secure, efficient, and reliable in the years that I’ve been using it. It’s also free and open-source, which is always a comfort.
I’ve started using BorgBase for offsite backups. I generally consider these backups to be my personal “disaster recovery” backups. This means, if my house burns down, or someone manages to ransomware all of my data, I can still get back what I need.">

  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Securing Offsite Borg Backups with Secretive and BorgBase",
    "headline": "Securing Offsite Borg Backups with Secretive and BorgBase",
    
    "abstract": "\u003ch2 id=\u0022borg\u0022 class=\u0022relative group\u0022\u003eBorg \u003cspan class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100\u0022\u003e\u003ca class=\u0022group-hover:text-primary-300 dark:group-hover:text-neutral-700\u0022 style=\u0022text-decoration-line: none !important;\u0022 href=\u0022#borg\u0022 aria-label=\u0022Anchor\u0022\u003e#\u003c\/a\u003e\u003c\/span\u003e\u003c\/h2\u003e\u003cp\u003eI am a big fan of \u003ca href=\u0022https:\/\/www.borgbackup.org\/\u0022 target=\u0022_blank\u0022 rel=\u0022noreferrer\u0022\u003eBorg Backup\u003c\/a\u003e for my backup needs. It\u0026rsquo;s proven fast,\nsecure, efficient, and reliable in the years that I\u0026rsquo;ve been using it. It\u0026rsquo;s also free and\nopen-source, which is always a comfort.\u003c\/p\u003e\n\u003cp\u003eI\u0026rsquo;ve started using \u003ca href=\u0022https:\/\/www.borgbackup.org\/\u0022 target=\u0022_blank\u0022 rel=\u0022noreferrer\u0022\u003eBorgBase\u003c\/a\u003e for offsite backups. I generally\nconsider these backups to be my personal \u0026ldquo;disaster recovery\u0026rdquo; backups. This means, if my house\nburns down, or someone manages to ransomware all of my data, I can still get back what I need.\u003c\/p\u003e",
    "inLanguage": "en-us",
    "url" : "https:\/\/ericsweb.site\/posts\/2022-08-28-borgbackup-and-secretive\/",
    "author" : {
      "@type": "Person",
      "name": "Eric Miller"
    },
    "copyrightYear": "2022",
    "dateCreated": "2022-08-28T21:00:00-05:00",
    "datePublished": "2022-08-28T21:00:00-05:00",
    
    "dateModified": "2022-08-28T21:00:00-05:00",
    
    "keywords": ["borg","backup","borgbackup","borgmatic","borgbase","secretive","secret enclave","apple","tutorial"],
    
    "mainEntityOfPage": "true",
    "wordCount": "578"
  }
  </script>
    
    <script type="application/ld+json">
    {
   "@context": "https://schema.org",
   "@type": "BreadcrumbList",
   "itemListElement": [
     {
       "@type": "ListItem",
       "item": "https://ericsweb.site/",
       "name": "Index",
       "position": 1
     },
     {
       "@type": "ListItem",
       "item": "https://ericsweb.site/posts/",
       "name": "Posts",
       "position": 2
     },
     {
       "@type": "ListItem",
       "item": "https://ericsweb.site/categories/technology/",
       "name": "Technology",
       "position": 3
     },
     {
       "@type": "ListItem",
       "name": "Securing Offsite Borg Backups With Secretive and Borg Base",
       "position": 4
     }
   ]
 }
  </script>

  
  <meta name="author" content="Eric Miller" />
  
    
      <link href="https://github.com/sosheskaz/" rel="me" />
    
  
  
  






  
  
  
  
  
  


  
  
</head>
<body
    class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content"
        ><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span
        >Skip to main content</a
      >
    </div>
    
    
      <header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden">
  <nav class="flex items-start justify-between sm:items-center">
    
    <div class="flex flex-row items-center">
      
  <a
    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
    rel="me"
    href="/"
    >Eric&rsquo;s Web.site</a
  >

    </div>
    
    
      <ul class="flex list-none flex-col text-end sm:flex-row">
        
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/posts/"
                  title="Posts"
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >All Posts</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/categories/"
                  title="Categories"
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Categories</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/profile/"
                  title="About Me"
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >About</span
                    >
                  </a
                >
              
            </li>
          
          
        
      </ul>
    
  </nav>
</header>

    
    <div class="relative flex grow flex-col">
      <main id="main-content" class="grow">
        
  <article>
    <header class="max-w-prose">
      
        <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="hidden inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="/"
      >Index</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class=" inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="/posts/"
      >Posts</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="hidden inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="/posts/2022-08-28-borgbackup-and-secretive/"
      >Securing Offsite Borg Backups with Secretive and BorgBase</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


      
      <h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        Securing Offsite Borg Backups with Secretive and BorgBase
      </h1>
      
        <div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
          





  
  



  

  
  
    
  

  

  

  
    
  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2022-08-28 21:00:00 -0500 CDT">August 28, 2022</time><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">3 mins</span>
    

    
    
  </div>

  
  


        </div>
      
      
    </header>
    <section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row">
      
      <div class="min-h-0 min-w-0 max-w-prose grow">
        <h2 id="borg" class="relative group">Borg <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#borg" aria-label="Anchor">#</a></span></h2><p>I am a big fan of <a href="https://www.borgbackup.org/" target="_blank" rel="noreferrer">Borg Backup</a> for my backup needs. It&rsquo;s proven fast,
secure, efficient, and reliable in the years that I&rsquo;ve been using it. It&rsquo;s also free and
open-source, which is always a comfort.</p>
<p>I&rsquo;ve started using <a href="https://www.borgbackup.org/" target="_blank" rel="noreferrer">BorgBase</a> for offsite backups. I generally
consider these backups to be my personal &ldquo;disaster recovery&rdquo; backups. This means, if my house
burns down, or someone manages to ransomware all of my data, I can still get back what I need.</p>
<p><em>Incidentally, one time I did need to use one of these to recover the key to my normal backups.</em>
Redundancy is its own reward! Redundancy is its own reward!</p>
<p>The ransomware use-case is particularly tricky for Borg. Because it is &ldquo;push&rdquo;-model backup software,
if an attacker can compromise the source machine, then they can compromise the remote repository as
well. Even ostensibly more secure systems, like the system keychain or SSH agent, can be compromised
by an attacker assuming a user session is active. This is a hard problem to work around.</p>
<p>Here is how to work around this problem.</p>
<h2 id="procedure" class="relative group">Procedure <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#procedure" aria-label="Anchor">#</a></span></h2><p>You will need:</p>
<ul>
<li>The SSH keys already used for your backups</li>
<li>An Apple MacBook with a Secure Enclave (or a Smart Card)
<ul>
<li>Install <a href="https://github.com/maxgoedjen/secretive" target="_blank" rel="noreferrer">Secretive</a></li>
</ul>
</li>
<li><a href="https://www.borgbase.com/register" target="_blank" rel="noreferrer">A BorgBase Account</a> (It&rsquo;s Free!)</li>
</ul>
<p>First, in BorgBase, we must make all of our current keys, which we use for unattended backups,
append-only for all of our backup repositories. This will allow them to create new backups in
BorgBase, but not to prune old backups. Then, we can leave our old backup configurations as they
are, using the old key. Remove any &ldquo;pruning&rdquo; configurations, as these machines will no longer have
pruning permissions.</p>
<p>Second, in Secretive, create a new SSH key, and configure it to require authentication
<strong>every time</strong> it is used. Add this SSH public key to BorgBase.</p>
<p>Third, for all of our repos in BorgBase, configure the new <em>Secretive</em> SSH key to have
<strong>full admin access</strong>.</p>
<p>






  
  
<figure><img src="./borgbase-repo-config.png" alt="Picture of BorgBase configuration interface, showing the Append-Only and Full Access fields" class="mx-auto my-0 rounded-md" />
</figure>
</p>
<p>Finally, create a script on the MacBook to prune backups for <strong>all</strong> of our repos. This can be done
by iterating over them via individual <code>borg prune</code> calls, or using a configuration manager like
<a href="https://torsion.org/borgmatic/" target="_blank" rel="noreferrer">Borgmatic</a>. The borg SSH args will also need to be modified to
work with Secretive by passing additional args like
<code>-i ~/Library/Containers/com.maxgoedjen.Secretive.SecretAgent/Data/PublicKeys/my-key.pub -o IdentityAgent=~/Library/Containers/com.maxgoedjen.Secretive.SecretAgent/Data/socket.ssh</code>, using the values found in the
Secretive app.</p>
<p>When run, this script will prompt for authentication via the secret enclave (via any available
biometric configuration) for each repository that you prune. This script can then be run manually on
whatever cadence is convenient and prudent.</p>
<p><strong>Important note</strong>: Append-only mode does not strictly prevent deletion, but configures delayed
deletion. Pruned backups will be deleted during the next compaction. For this reason, one should
validate the present state of the repository before running this prune/compact, as it will delete
anything pending. See also the relevant
<a href="https://borgbackup.readthedocs.io/en/stable/usage/notes.html?highlight=append-only#drawbacks" target="_blank" rel="noreferrer">BorgBackup</a>
and <a href="https://docs.borgbase.com/faq/#append-only-mode" target="_blank" rel="noreferrer">BorgBase</a> docs.</p>
<p>Remember to turn on 2FA for BorgBase too — to make it that much harder to compromise by altering the
keys in your account.</p>
<h2 id="closing" class="relative group">Closing <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#closing" aria-label="Anchor">#</a></span></h2><p>As a result, we now have a repository which our automated systems can back up to, using push-based
backups, on any cadence they wish. At the same time, destructive operations are now entirely
gatekept behind the MacBook&rsquo;s Secure Enclave and our biometric authentication.</p>
<p>Even a total ransomware compromise, which detected the remote backups, pushed bad data to them,
could not delete the old backups, ensuring almost total safety in the event of a compromise.</p>

      </div>
    </section>
    <footer class="max-w-prose pt-8 print:hidden">
      
  <div class="flex">
    
    
    
      
      
    
    <div class="place-self-center">
      
        <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
          Author
        </div>
        <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
          Eric Miller
        </div>
      
      
        <div class="text-sm text-neutral-700 dark:text-neutral-400">Software Engineer, Kuberneter</div>
      
      <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400"
          style="will-change:transform;"
          href="https://github.com/sosheskaz/"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="icon relative inline-block px-1 align-text-bottom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></a
        >
      
    
  </div>

</div>
    </div>
  </div>


      

      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="group flex" href="/posts/bearclaw-cornstalk-turtles-getyolked/">
              <span
                class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&larr;</span
                ><span class="ltr:hidden rtl:inline">&rarr;</span></span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Bearclaw. Cornstalk. Turtles. Get Yolked.</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2019-11-29 00:00:00 &#43;0000 UTC">November 29, 2019</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="group flex text-right" href="/posts/2022-09-12-groucho-henry/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Groucho Henry</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2022-09-12 19:19:53 -0500 CDT">September 12, 2022</time>
                  
                </span>
              </span>
              <span
                class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[-2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&rarr;</span
                ><span class="ltr:hidden rtl:inline">&larr;</span></span
              >
            </a>
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

      </main>
      
        <div
          class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"
          id="to-top"
          hidden="true"
        >
          <a
            href="#the-top"
            class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
            aria-label="Scroll to top"
            title="Scroll to top"
          >
            &uarr;
          </a>
        </div>
      <footer class="py-10 print:hidden">
  
  
  <div class="flex items-center justify-between">
    <div>
      
      
        <p class="text-sm text-neutral-500 dark:text-neutral-400">
            &copy;
            2025
            Eric Miller
        </p>
      
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://github.com/jpanther/congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    <div class="flex flex-row items-center">
      
      
      
      
    </div>
  </div>
  
  
</footer>

    </div>
  </body>
</html>
